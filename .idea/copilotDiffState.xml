<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/com/antam/app/controller/dialog/SuaKhachHangController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/antam/app/controller/dialog/SuaKhachHangController.java" />
              <option name="updatedContent" value="/*&#10; * @ (#) SuaKhachHangController.java   1.0 28/10/25&#10; *&#10; * Copyright (c) 2025 IUH. All rights reserved.&#10; */&#10;package com.antam.app.controller.dialog;&#10;&#10;import com.antam.app.dao.KhachHang_DAO;&#10;import com.antam.app.entity.KhachHang;&#10;import javafx.fxml.FXML;&#10;import javafx.fxml.Initializable;&#10;import javafx.scene.control.Alert;&#10;import javafx.scene.control.Button;&#10;import javafx.scene.control.TextField;&#10;&#10;import java.net.URL;&#10;import java.util.ResourceBundle;&#10;&#10;/*&#10; * @description Controller for updating customer information&#10; * @author: Tran Tuan Hung&#10; * @date: 28/10/25&#10; * @version: 1.0&#10; */&#10;public class SuaKhachHangController implements Initializable {&#10;&#10;    @FXML&#10;    private TextField txtMaKhachHang;&#10;&#10;    @FXML&#10;    private TextField txtTenKhachHang;&#10;&#10;    @FXML&#10;    private TextField txtSoDienThoai;&#10;&#10;    @FXML&#10;    private Button btnLuu;&#10;&#10;    @FXML&#10;    private Button btnHuy;&#10;&#10;    private KhachHang khachHang;&#10;    private KhachHang_DAO khachHangDAO;&#10;&#10;    @Override&#10;    public void initialize(URL location, ResourceBundle resources) {&#10;        // Khởi tạo DAO&#10;        khachHangDAO = new KhachHang_DAO();&#10;&#10;        // Thiết lập sự kiện cho nút Lưu&#10;        btnLuu.setOnAction(event -&gt; handleLuu());&#10;&#10;        // Thiết lập sự kiện cho nút Hủy&#10;        btnHuy.setOnAction(event -&gt; handleHuy());&#10;    }&#10;&#10;    /**&#10;     * Thiết lập dữ liệu khách hàng để hiển thị trong form&#10;     */&#10;    public void setKhachHang(KhachHang kh) {&#10;        this.khachHang = kh;&#10;        if (khachHang != null) {&#10;            txtMaKhachHang.setText(khachHang.getMaKH());&#10;            txtTenKhachHang.setText(khachHang.getTenKH());&#10;            txtSoDienThoai.setText(khachHang.getSoDienThoai());&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xử lý sự kiện click nút Lưu&#10;     */&#10;    private void handleLuu() {&#10;        // Kiểm tra dữ liệu đầu vào&#10;        if (txtTenKhachHang.getText().trim().isEmpty()) {&#10;            showError(&quot;Lỗi&quot;, &quot;Tên khách hàng không được để trống&quot;);&#10;            return;&#10;        }&#10;&#10;        if (txtSoDienThoai.getText().trim().isEmpty()) {&#10;            showError(&quot;Lỗi&quot;, &quot;Số điện thoại không được để trống&quot;);&#10;            return;&#10;        }&#10;&#10;        // Kiểm tra định dạng số điện thoại (đơn giản: chỉ chứa số)&#10;        if (!txtSoDienThoai.getText().matches(&quot;\\d+&quot;)) {&#10;            showError(&quot;Lỗi&quot;, &quot;Số điện thoại phải chỉ chứa các chữ số&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            // Cập nhật thông tin khách hàng&#10;            khachHang.setTenKH(txtTenKhachHang.getText().trim());&#10;            khachHang.setSoDienThoai(txtSoDienThoai.getText().trim());&#10;&#10;            // Lưu vào database&#10;            boolean success = khachHangDAO.updateKhachHang(khachHang);&#10;&#10;            if (success) {&#10;                showInfo(&quot;Thành công&quot;, &quot;Cập nhật thông tin khách hàng thành công&quot;);&#10;                // Đóng dialog&#10;                btnHuy.getScene().getWindow().hide();&#10;            } else {&#10;                showError(&quot;Lỗi&quot;, &quot;Không thể cập nhật thông tin khách hàng&quot;);&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            showError(&quot;Lỗi&quot;, &quot;Lỗi khi cập nhật: &quot; + e.getMessage());&#10;            e.printStackTrace();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xử lý sự kiện click nút Hủy&#10;     */&#10;    private void handleHuy() {&#10;        // Đóng dialog mà không lưu&#10;        btnHuy.getScene().getWindow().hide();&#10;    }&#10;&#10;    /**&#10;     * Hiển thị dialog lỗi&#10;     */&#10;    private void showError(String title, String message) {&#10;        Alert alert = new Alert(Alert.AlertType.ERROR);&#10;        alert.setTitle(title);&#10;        alert.setHeaderText(null);&#10;        alert.setContentText(message);&#10;        alert.showAndWait();&#10;    }&#10;&#10;    /**&#10;     * Hiển thị dialog thông tin&#10;     */&#10;    private void showInfo(String title, String message) {&#10;        Alert alert = new Alert(Alert.AlertType.INFORMATION);&#10;        alert.setTitle(title);&#10;        alert.setHeaderText(null);&#10;        alert.setContentText(message);&#10;        alert.showAndWait();&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/com/antam/app/controller/hoadon/ThemHoaDonFormController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/antam/app/controller/hoadon/ThemHoaDonFormController.java" />
              <option name="originalContent" value="//&#10;// Source code recreated from a .class file by IntelliJ IDEA&#10;// (powered by FernFlower decompiler)&#10;//&#10;&#10;package com.antam.app.controller.hoadon;&#10;&#10;import com.antam.app.dao.*;&#10;import com.antam.app.entity.*;&#10;import javafx.collections.FXCollections;&#10;import javafx.fxml.FXML;&#10;import javafx.scene.control.*;&#10;import javafx.scene.control.ButtonBar.ButtonData;&#10;import javafx.scene.layout.HBox;&#10;import javafx.scene.layout.VBox;&#10;import javafx.scene.text.Text;&#10;&#10;import java.text.DecimalFormat;&#10;import java.text.DecimalFormatSymbols;&#10;import java.util.List;&#10;import java.util.stream.Collectors;&#10;&#10;public class ThemHoaDonFormController {&#10;    @FXML&#10;    private DialogPane dialogPane;&#10;    @FXML&#10;    private TextField txtMaHoaDon;&#10;    @FXML&#10;    private TextField txtSoDienThoai;&#10;    @FXML&#10;    private TextField txtTenKhachHang;&#10;    @FXML&#10;    private ComboBox&lt;Thuoc&gt; cbMedicine;&#10;    @FXML&#10;    private ComboBox&lt;DonViTinh&gt; cb_unit;&#10;    @FXML&#10;    private TextField txt_price;&#10;    @FXML&#10;    private TextField txtQuantity;&#10;    @FXML&#10;    private Text txtTamTinh;&#10;    @FXML&#10;    private Text txtThue;&#10;    @FXML&#10;    private Text txtTongTien;&#10;    @FXML&#10;    private VBox medicineRowsVBox;&#10;    @FXML&#10;    private Button btnThemThuoc;&#10;    @FXML&#10;    private ComboBox&lt;KhuyenMai&gt; cb_promotion;&#10;    @FXML&#10;    private Text txtThongTinKhuyenMai;&#10;    @FXML&#10;    private Text txtWarning;&#10;&#10;    // Định dạng tiền tệ kiểu Việt Nam: 1.000đ, 10.000đ&#10;    private static final DecimalFormat VND_FORMAT;&#10;    static {&#10;        DecimalFormatSymbols symbols = new DecimalFormatSymbols();&#10;        symbols.setGroupingSeparator('.');&#10;        symbols.setDecimalSeparator(',');&#10;        VND_FORMAT = new DecimalFormat(&quot;#,##0&quot;, symbols);&#10;    }&#10;&#10;    public ThemHoaDonFormController() {&#10;    }&#10;&#10;    public void initialize() {&#10;        ButtonType cancelButton = new ButtonType(&quot;Huỷ&quot;, ButtonData.CANCEL_CLOSE);&#10;        ButtonType applyButton = new ButtonType(&quot;Tạo hoá đơn&quot;, ButtonData.APPLY);&#10;        this.dialogPane.getButtonTypes().add(cancelButton);&#10;        this.dialogPane.getButtonTypes().add(applyButton);&#10;&#10;        // Tự động sinh mã hoá đơn mới&#10;        txtMaHoaDon.setText(generateNewMaHoaDon());&#10;        txtMaHoaDon.setEditable(false); // Khóa không cho sửa mã hoá đơn&#10;&#10;        // Xử lý tìm kiếm khách hàng realtime khi nhập số điện thoại&#10;        KhachHang_DAO khachHangDAO = new KhachHang_DAO();&#10;        txtSoDienThoai.textProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;            if (newVal != null &amp;&amp; !newVal.trim().isEmpty()) {&#10;                // Tìm khách hàng theo số điện thoại&#10;                KhachHang kh = khachHangDAO.getKhachHangTheoSoDienThoai(newVal.trim());&#10;                if (kh != null) {&#10;                    // Nếu tìm thấy khách hàng, tự động điền tên và disable ô tên&#10;                    txtTenKhachHang.setText(kh.getTenKH());&#10;                    txtTenKhachHang.setDisable(true);&#10;                    txtTenKhachHang.setStyle(&quot;-fx-opacity: 1.0;&quot;); // Giữ màu chữ rõ ràng khi disable&#10;                } else {&#10;                    // Nếu không tìm thấy, cho phép nhập tên mới&#10;                    txtTenKhachHang.clear();&#10;                    txtTenKhachHang.setDisable(false);&#10;                    txtTenKhachHang.setStyle(&quot;&quot;);&#10;                }&#10;            } else {&#10;                // Nếu xóa số điện thoại, reset ô tên&#10;                txtTenKhachHang.clear();&#10;                txtTenKhachHang.setDisable(false);&#10;                txtTenKhachHang.setStyle(&quot;&quot;);&#10;            }&#10;        });&#10;&#10;        // Load thuốc vào cbMedicine&#10;        Thuoc_DAO thuocDAO = new Thuoc_DAO();&#10;        var thuocList = FXCollections.observableArrayList(thuocDAO.getAllThuoc());&#10;        cbMedicine.setItems(thuocList);&#10;        cbMedicine.setConverter(new javafx.util.StringConverter&lt;&gt;() {&#10;            @Override&#10;            public String toString(Thuoc thuoc) {&#10;                return thuoc == null ? &quot;&quot; : thuoc.getTenThuoc();&#10;            }&#10;            @Override&#10;            public Thuoc fromString(String s) {&#10;                return thuocList.stream().filter(t -&gt; t.getTenThuoc().equals(s)).findFirst().orElse(null);&#10;            }&#10;        });&#10;&#10;//        cbMedicine.valueProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;//            if (newVal != null) {&#10;//                // Lấy danh sách đơn vị tính quy đổi cho thuốc&#10;//                QuyDoi_DAO quyDoiDAO = new QuyDoi_DAO();&#10;//                DonViTinh_DAO donViTinhDAO = new DonViTinh_DAO();&#10;//                var allQuyDoi = quyDoiDAO.getAllQuyDoi();&#10;//                var quyDoiList = allQuyDoi.getOrDefault(newVal.getMaThuoc(), List.of());&#10;//                HashSet&lt;Integer&gt; dvtIdSet = new HashSet&lt;&gt;();&#10;//                // Thêm đơn vị cơ sở&#10;//                dvtIdSet.add(newVal.getMaDVTCoSo().getMaDVT());&#10;//                // Thêm các đơn vị quy đổi&#10;//                for (QuyDoi qd : quyDoiList) {&#10;//                    dvtIdSet.add(qd.getMaDVTCha().getMaDVT());&#10;//                    dvtIdSet.add(qd.getMaDVTCon().getMaDVT());&#10;//                }&#10;//                HashSet&lt;DonViTinh&gt; dvtSet = new HashSet&lt;&gt;();&#10;//                for (Integer maDVT : dvtIdSet) {&#10;//                    DonViTinh dvt = donViTinhDAO.getDVTTheoMa(maDVT);&#10;//                    if (dvt != null) dvtSet.add(dvt);&#10;//                }&#10;//                cb_unit.setItems(FXCollections.observableArrayList(dvtSet));&#10;//                cb_unit.getSelectionModel().selectFirst();&#10;//                // Hiển thị giá bán&#10;//                txt_price.setText(VND_FORMAT.format(newVal.getGiaBan()) + &quot;đ&quot;);&#10;//                updateSummary();&#10;//            } else {&#10;//                cb_unit.getItems().clear();&#10;//                txt_price.clear();&#10;//                txtTamTinh.setText(&quot;&quot;);&#10;//                txtThue.setText(&quot;&quot;);&#10;//                txtTongTien.setText(&quot;&quot;);&#10;//            }&#10;//        });&#10;        txtQuantity.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        txt_price.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        cb_unit.valueProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        btnThemThuoc.setOnAction(e -&gt; addMedicineRow());&#10;        if (!medicineRowsVBox.getChildren().isEmpty() &amp;&amp; medicineRowsVBox.getChildren().get(0) instanceof HBox hbox) {&#10;            setupMedicineRow(hbox);&#10;        }&#10;&#10;        // Load khuyến mãi vào cb_promotion&#10;        KhuyenMai_DAO khuyenMaiDAO = new KhuyenMai_DAO();&#10;        var dsKhuyenMai = khuyenMaiDAO.getAllKhuyenMaiConHieuLuc();&#10;        cb_promotion.setItems(FXCollections.observableArrayList(dsKhuyenMai));&#10;        cb_promotion.setConverter(new javafx.util.StringConverter&lt;&gt;() {&#10;            @Override&#10;            public String toString(KhuyenMai km) {&#10;                return km == null ? &quot;&quot; : km.getTenKM();&#10;            }&#10;            @Override&#10;            public KhuyenMai fromString(String s) {&#10;                return dsKhuyenMai.stream().filter(km -&gt; km.getTenKM().equals(s)).findFirst().orElse(null);&#10;            }&#10;        });&#10;&#10;        // Hiển thị thông tin khuyến mãi khi chọn&#10;        cb_promotion.valueProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;            if (newVal != null) {&#10;                txtThongTinKhuyenMai.setText(&#10;                    String.format(&quot;%s (Từ %s đến %s)\nLoại: %s, Giá trị: %s%s&quot;,&#10;                        newVal.getTenKM(),&#10;                        newVal.getNgayBatDau(),&#10;                        newVal.getNgayKetThuc(),&#10;                        newVal.getLoaiKhuyenMai().getTenLKM(),&#10;                        newVal.getSo(),&#10;                        newVal.getLoaiKhuyenMai().getTenLKM().toLowerCase().contains(&quot;%&quot;) ? &quot;%&quot; : &quot;&quot;&#10;                    )&#10;                );&#10;            } else {&#10;                txtThongTinKhuyenMai.setText(&quot;&quot;);&#10;            }&#10;            updateSummary();&#10;        });&#10;&#10;        // Xử lý khi nhấn nút tạo hoá đơn&#10;        Button btnTaoHoaDon = (Button) dialogPane.lookupButton(applyButton);&#10;        // Validate dữ liệu trước khi tạo hoá đơn&#10;        btnTaoHoaDon.addEventFilter(javafx.event.ActionEvent.ACTION, e -&gt; {&#10;            // Reset warning&#10;            txtWarning.setVisible(false);&#10;            txtWarning.setText(&quot;&quot;);&#10;&#10;            // Validate số điện thoại&#10;            String soDienThoai = txtSoDienThoai.getText().trim();&#10;            if (soDienThoai.isEmpty()) {&#10;                txtWarning.setText(&quot;Vui lòng nhập số điện thoại khách hàng!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;&#10;            // Validate tên khách hàng&#10;            String tenKH = txtTenKhachHang.getText().trim();&#10;            if (tenKH.isEmpty()) {&#10;                txtWarning.setText(&quot;Vui lòng nhập tên khách hàng!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            boolean hasMedicine = false;&#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    ComboBox&lt;Thuoc&gt; cb = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                    if (cb.getValue() != null) {&#10;                        hasMedicine = true;&#10;                        break;&#10;                    }&#10;                }&#10;            }&#10;            if (!hasMedicine) {&#10;                txtWarning.setText(&quot;Vui lòng chọn ít nhất một thuốc!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            boolean hasQuantity = false;&#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                    if (!txtQuantity.getText().trim().isEmpty()) {&#10;                        hasQuantity = true;&#10;                        break;&#10;                    }&#10;                }&#10;            }&#10;            if (!hasQuantity) {&#10;                txtWarning.setText(&quot;Vui lòng nhập số lượng thuốc!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            } else {&#10;                // Kiểm tra số lượng có hợp lệ không&#10;                for (var node : medicineRowsVBox.getChildren()) {&#10;                    if (node instanceof HBox hbox) {&#10;                        TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                        String qtyStr = txtQuantity.getText().trim();&#10;                        if (!qtyStr.isEmpty()) {&#10;                            try {&#10;                                int qty = Integer.parseInt(qtyStr);&#10;                                if (qty &lt;= 0) {&#10;                                    txtWarning.setText(&quot;Số lượng thuốc phải là số nguyên dương!&quot;);&#10;                                    txtWarning.setVisible(true);&#10;                                    e.consume();&#10;                                    return;&#10;                                }&#10;                            } catch (NumberFormatException ex) {&#10;                                txtWarning.setText(&quot;Số lượng thuốc phải là số nguyên hợp lệ!&quot;);&#10;                                txtWarning.setVisible(true);&#10;                                e.consume();&#10;                                return;&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;            // Kiểm tra tồn kho cho từng thuốc&#10;            ChiTietThuoc_DAO chiTietThuocDAO = new ChiTietThuoc_DAO();&#10;            boolean enoughStock = true;&#10;            String outOfStockMedicine = null;&#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    ComboBox&lt;Thuoc&gt; cb = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                    TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                    Thuoc thuoc = cb.getValue();&#10;                    int soLuong = 0;&#10;                    try { soLuong = Integer.parseInt(txtQuantity.getText().trim()); } catch(Exception ex) {}&#10;                    if (thuoc != null &amp;&amp; soLuong &gt; 0) {&#10;                        int tongTonKho = chiTietThuocDAO.getTongTonKhoTheoMaThuoc(thuoc.getMaThuoc());&#10;                        if (tongTonKho &lt; soLuong) {&#10;                            enoughStock = false;&#10;                            outOfStockMedicine = thuoc.getTenThuoc();&#10;                            break;&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;            if (!enoughStock) {&#10;                txtWarning.setText(&quot;Số lượng tồn không đủ cho thuốc: &quot; + outOfStockMedicine);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            // Tiến hành tạo hoá đơn&#10;            txtWarning.setVisible(false);&#10;            txtWarning.setText(&quot;&quot;);&#10;&#10;            // 1. Lấy mã khách hàng (tự động thêm nếu chưa có)&#10;            String maKH = getOrCreateMaKhachHang();&#10;            KhachHang kh = khachHangDAO.getKhachHangTheoMa(maKH);&#10;&#10;            // 2. Lấy nhân viên (nếu có ComboBox chọn nhân viên, ví dụ cbEmployee)&#10;            NhanVien_DAO nhanVienDAO = new NhanVien_DAO();&#10;            NhanVien nhanVien = PhienNguoiDung.getMaNV(); // Hardcode mã nhân viên&#10;            if (nhanVien == null || nhanVien.getMaNV() == null) {&#10;                txtWarning.setText(&quot;Không tìm thấy nhân viên hợp lệ! Không thể tạo hóa đơn.&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;&#10;            // 3. Lấy khuyến mãi (đã có đối tượng km)&#10;            KhuyenMai km = cb_promotion.getValue();&#10;            // 4. Lấy mã hoá đơn&#10;            String maHD = txtMaHoaDon.getText().trim();&#10;            // 5. Lấy tổng tiền, tạm tính, thuế, khuyến mãi&#10;            double tongTien = 0, tamTinh = 0, thue = 0, giam = 0;&#10;            try { tamTinh = parseCurrency(txtTamTinh.getText()); } catch(Exception ex) {}&#10;            try { thue = parseCurrency(txtThue.getText()); } catch(Exception ex) {}&#10;            try {&#10;                String tong = txtTongTien.getText().replaceAll(&quot;[^0-9]&quot;, &quot;&quot;);&#10;                tongTien = tong.isEmpty() ? 0 : Double.parseDouble(tong);&#10;            } catch(Exception ex) {}&#10;            // 6. Tạo hoá đơn đúng kiểu constructor&#10;            HoaDon_DAO hoaDonDAO = new HoaDon_DAO();&#10;            HoaDon hoaDon = new HoaDon(maHD, java.time.LocalDate.now(), nhanVien, kh, km, tongTien, false);&#10;            boolean hoaDonInserted = hoaDonDAO.insertHoaDon(hoaDon);&#10;            if (!hoaDonInserted) {&#10;                txtWarning.setText(&quot;Tạo hóa đơn thất bại! Vui lòng kiểm tra lại thông tin.&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            // 5. Thêm chi tiết hoá đơn cho từng thuốc và trừ kho&#10;            ChiTietHoaDon_DAO chiTietHoaDonDAO = new ChiTietHoaDon_DAO();&#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    ComboBox&lt;Thuoc&gt; cb = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                    ComboBox&lt;DonViTinh&gt; cbUnit = (ComboBox&lt;DonViTinh&gt;) hbox.getChildren().get(1);&#10;                    TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                    TextField txtPrice = (TextField) hbox.getChildren().get(3);&#10;                    txtPrice.setEditable(false); // Khóa không cho sửa giá&#10;                    Thuoc thuoc = cb.getValue();&#10;                    DonViTinh dvt = cbUnit.getValue();&#10;                    int soLuong = 0;&#10;                    double donGia = 0;&#10;                    try { soLuong = Integer.parseInt(txtQuantity.getText().trim()); } catch(Exception ex) {}&#10;                    try { donGia = parseCurrency(txtPrice.getText().trim()); } catch(Exception ex) {}&#10;                    if (thuoc != null &amp;&amp; dvt != null &amp;&amp; soLuong &gt; 0) {&#10;                        // Lấy danh sách các lô ChiTietThuoc còn tồn kho cho thuốc này&#10;                        List&lt;ChiTietThuoc&gt; listCTT = chiTietThuocDAO.getAllChiTietThuoc().stream()&#10;                            .filter(ctt -&gt; ctt.getMaThuoc().getMaThuoc().equals(thuoc.getMaThuoc()) &amp;&amp; ctt.getSoLuong() &gt; 0)&#10;                            .sorted(java.util.Comparator.comparing(ctt -&gt; ctt.getHanSuDung())) // Ưu tiên lô hết hạn trước&#10;                            .collect(Collectors.toList());&#10;                        int soLuongConLai = soLuong;&#10;                        for (ChiTietThuoc ctt : listCTT) {&#10;                            if (soLuongConLai &lt;= 0) break;&#10;                            int soLuongXuat = Math.min(ctt.getSoLuong(), soLuongConLai);&#10;                            if (soLuongXuat &lt;= 0) continue;&#10;                            ChiTietHoaDon cthd = new ChiTietHoaDon(new HoaDon(maHD), ctt, soLuongXuat, dvt, &quot;Bán&quot;, soLuongXuat * donGia);&#10;                            chiTietHoaDonDAO.themChiTietHoaDon(cthd);&#10;                            // Trừ kho lô này (nếu có hàm updateTonKho thì gọi ở đây)&#10;                            chiTietThuocDAO.CapNhatSoLuongChiTietThuoc(ctt.getMaCTT(), -soLuongXuat);&#10;                            soLuongConLai -= soLuongXuat;&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;            // Đóng dialog (nếu cần, có thể show alert thành công ở đây)&#10;            dialogPane.getScene().getWindow().hide();&#10;            Alert successAlert = new Alert(Alert.AlertType.INFORMATION);&#10;            successAlert.setTitle(&quot;Tạo hoá đơn thành công&quot;);&#10;            successAlert.setHeaderText(null);&#10;            successAlert.setContentText(&quot;Hoá đơn đã được tạo thành công!&quot;);&#10;            successAlert.showAndWait();&#10;        });&#10;    }&#10;&#10;    // Thêm một hàng thuốc mới vào VBox chứa các hàng thuốc&#10;    private void addMedicineRow() {&#10;        HBox hbox = new HBox(10);&#10;        hbox.setStyle(&quot;-fx-background-color: #f8fafc;&quot;);&#10;        hbox.setPadding(new javafx.geometry.Insets(10));&#10;        ComboBox&lt;Thuoc&gt; cbMedicine = new ComboBox&lt;&gt;();&#10;        cbMedicine.setPrefWidth(150);&#10;        cbMedicine.setPromptText(&quot;Chọn thuốc&quot;);&#10;        cbMedicine.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        ComboBox&lt;DonViTinh&gt; cb_unit = new ComboBox&lt;&gt;();&#10;        cb_unit.setPrefWidth(150);&#10;        cb_unit.setPromptText(&quot;Đơn vị&quot;);&#10;        cb_unit.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        TextField txtQuantity = new TextField();&#10;        txtQuantity.setPromptText(&quot;Số lượng&quot;);&#10;        txtQuantity.getStyleClass().add(&quot;text-field&quot;);&#10;        txtQuantity.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        TextField txt_price = new TextField();&#10;        txt_price.setPromptText(&quot;Đơn giá&quot;);&#10;        txt_price.getStyleClass().add(&quot;text-field&quot;);&#10;        txt_price.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        Button btnRemove = new Button(&quot;X&quot;);&#10;        btnRemove.setStyle(&#10;            &quot;-fx-padding: 5 8 5 8;&quot; +&#10;            &quot;-fx-background-color: #ef4444;&quot; +&#10;            &quot;-fx-background-radius: 50%;&quot; +&#10;            &quot;-fx-text-fill: white;&quot; +&#10;            &quot;-fx-font-size: 14px;&quot; +&#10;            &quot;-fx-font-weight: bold;&quot;&#10;        );&#10;        btnRemove.setOnAction(e -&gt; medicineRowsVBox.getChildren().remove(hbox));&#10;        hbox.getChildren().addAll(cbMedicine, cb_unit, txtQuantity, txt_price, btnRemove);&#10;        medicineRowsVBox.getChildren().add(hbox);&#10;        setupMedicineRow(hbox);&#10;    }&#10;&#10;    // Thiết lập sự kiện và logic cho một hàng thuốc mới thêm vào&#10;    private void setupMedicineRow(HBox hbox) {&#10;        ComboBox&lt;Thuoc&gt; cbMedicine = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;        ComboBox&lt;DonViTinh&gt; cb_unit = (ComboBox&lt;DonViTinh&gt;) hbox.getChildren().get(1);&#10;        TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;        TextField txt_price = (TextField) hbox.getChildren().get(3);&#10;        txt_price.setEditable(false); // Khóa không cho sửa giá&#10;        Thuoc_DAO thuocDAO = new Thuoc_DAO();&#10;        var thuocList = FXCollections.observableArrayList(thuocDAO.getAllThuoc());&#10;        cbMedicine.setItems(thuocList);&#10;        cbMedicine.setConverter(new javafx.util.StringConverter&lt;&gt;() {&#10;            @Override&#10;            public String toString(Thuoc thuoc) {&#10;                return thuoc == null ? &quot;&quot; : thuoc.getTenThuoc();&#10;            }&#10;            @Override&#10;            public Thuoc fromString(String s) {&#10;                return thuocList.stream().filter(t -&gt; t.getTenThuoc().equals(s)).findFirst().orElse(null);&#10;            }&#10;        });&#10;&#10;        // Khi chọn thuốc, tự động set đơn vị cơ sở và không cho chọn đơn vị khác&#10;        cbMedicine.valueProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;            if (newVal != null) {&#10;                DonViTinh_DAO donViTinhDAO = new DonViTinh_DAO();&#10;                // Chỉ lấy đơn vị cơ sở của thuốc&#10;                DonViTinh dvtCoSo = newVal.getMaDVTCoSo();&#10;                if (dvtCoSo != null) {&#10;                    // Lấy thông tin đầy đủ của đơn vị tính từ database&#10;                    DonViTinh dvtFull = donViTinhDAO.getDVTTheoMa(dvtCoSo.getMaDVT());&#10;                    if (dvtFull != null) {&#10;                        cb_unit.setItems(FXCollections.observableArrayList(dvtFull));&#10;                        cb_unit.getSelectionModel().selectFirst();&#10;                        cb_unit.setDisable(true); // Không cho chọn đơn vị khác&#10;                    }&#10;                }&#10;                // Hiển thị giá bán&#10;                txt_price.setText(VND_FORMAT.format(newVal.getGiaBan()) + &quot;đ&quot;);&#10;            } else {&#10;                cb_unit.getItems().clear();&#10;                cb_unit.setDisable(false);&#10;                txt_price.clear();&#10;            }&#10;            updateSummary();&#10;        });&#10;&#10;        txtQuantity.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        txt_price.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        cb_unit.valueProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;    }&#10;&#10;    //Hàm tính tổng tiền, tạm tính Cập nhật lại phần tóm tắt hoá đơn (tạm tính, thuế, tổng tiền)&#10;    private void updateSummary() {&#10;        double tongTamTinh = 0;&#10;        double tongThue = 0;&#10;        double tongTien = 0;&#10;        for (var node : medicineRowsVBox.getChildren()) {&#10;            if (node instanceof HBox hbox) {&#10;                ComboBox&lt;Thuoc&gt; cbMedicine = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                TextField txt_price = (TextField) hbox.getChildren().get(3);&#10;                txt_price.setEditable(false); // Khóa không cho sửa giá&#10;                int quantity = 0;&#10;                try {&#10;                    quantity = Integer.parseInt(txtQuantity.getText().trim());&#10;                } catch (Exception ignored) {}&#10;                double price = 0;&#10;                try {&#10;                    price = parseCurrency(txt_price.getText().trim());&#10;                } catch (Exception ignored) {}&#10;                double taxPercent = 0;&#10;                Thuoc selectedThuoc = cbMedicine.getValue();&#10;                if (selectedThuoc != null) {&#10;                    taxPercent = selectedThuoc.getThue();&#10;                }&#10;                double tamTinh = quantity * price;&#10;                // Tính thuế VAT: giá chưa bao gồm thuế, thuế = thành tiền × tỷ lệ thuế&#10;                double thue = tamTinh * taxPercent;&#10;                tongTamTinh += tamTinh;&#10;                tongThue += thue;&#10;            }&#10;        }&#10;        tongTien = tongTamTinh + tongThue;&#10;        // Áp dụng khuyến mãi nếu có&#10;        KhuyenMai km = cb_promotion.getValue();&#10;        double giam = 0;&#10;        if (km != null) {&#10;            double so = km.getSo();&#10;            if (so &lt; 100) {&#10;                giam = tongTien * so / 100.0;&#10;            } else if (so &gt;= 1000) {&#10;                giam = so;&#10;            }&#10;            if (giam &gt; tongTien) giam = tongTien;&#10;            tongTien -= giam;&#10;        }&#10;        txtTamTinh.setText(VND_FORMAT.format(tongTamTinh) + &quot;đ&quot;);&#10;        txtThue.setText(VND_FORMAT.format(tongThue) + &quot;đ&quot;);&#10;        if (km != null &amp;&amp; giam &gt; 0) {&#10;            txtTongTien.setText(VND_FORMAT.format(tongTien) + &quot;đ (đã giảm &quot; + VND_FORMAT.format(giam) + &quot;đ)&quot;);&#10;        } else {&#10;            txtTongTien.setText(VND_FORMAT.format(tongTien) + &quot;đ&quot;);&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Sinh mã hoá đơn mới chưa tồn tại trong CSDL dạng HDxxx&#10;     */&#10;    private String generateNewMaHoaDon() {&#10;        HoaDon_DAO hoaDonDAO = new HoaDon_DAO();&#10;        List&lt;String&gt; allMaHD = hoaDonDAO.getAllHoaDon().stream().map(hd -&gt; hd.getMaHD()).collect(Collectors.toList());&#10;        int max = 0;&#10;        for (String ma : allMaHD) {&#10;            if (ma != null &amp;&amp; ma.matches(&quot;HD\\d+&quot;)) {&#10;                int num = Integer.parseInt(ma.substring(2));&#10;                if (num &gt; max) max = num;&#10;            }&#10;        }&#10;        return String.format(&quot;HD%03d&quot;, max + 1);&#10;    }&#10;&#10;    // Xử lý khi nhấn nút tạo hóa đơn - Lấy hoặc tạo mã khách hàng dựa trên số điện thoại&#10;    private String getOrCreateMaKhachHang() {&#10;        String soDienThoai = txtSoDienThoai.getText().trim();&#10;        String tenKH = txtTenKhachHang.getText().trim();&#10;        if (soDienThoai.isEmpty() || tenKH.isEmpty()) return null;&#10;&#10;        KhachHang_DAO khachHangDAO = new KhachHang_DAO();&#10;&#10;        // Tìm khách hàng theo số điện thoại&#10;        KhachHang existingKH = khachHangDAO.getKhachHangTheoSoDienThoai(soDienThoai);&#10;        if (existingKH != null) {&#10;            // Nếu đã có khách hàng với số điện thoại này, trả về mã của họ&#10;            return existingKH.getMaKH();&#10;        }&#10;&#10;        // Nếu chưa có, tạo khách hàng mới với số điện thoại và tên đã nhập&#10;        List&lt;KhachHang&gt; allKH = khachHangDAO.getAllKhachHang();&#10;        String newMaKH = generateNewMaKhachHang(allKH);&#10;        KhachHang newKH = new KhachHang(newMaKH, tenKH, soDienThoai, false);&#10;        khachHangDAO.insertKhachHang(newKH);&#10;        return newMaKH;&#10;    }&#10;&#10;    // Sinh mã khách hàng mới chưa tồn tại trong CSDL dạng KHxxx hoặc KH000000001&#10;    private String generateNewMaKhachHang(List&lt;KhachHang&gt; allKH) {&#10;        int max = 0;&#10;        int digitCount = 3; // Mặc định nếu chưa có mã nào&#10;        for (KhachHang kh : allKH) {&#10;            String ma = kh.getMaKH();&#10;            if (ma != null &amp;&amp; ma.matches(&quot;KH\\d+&quot;)) {&#10;                String numberPart = ma.substring(2);&#10;                int num = Integer.parseInt(numberPart);&#10;                if (num &gt; max) max = num;&#10;                if (numberPart.length() &gt; digitCount) digitCount = numberPart.length();&#10;            }&#10;        }&#10;        return String.format(&quot;KH%0&quot; + digitCount + &quot;d&quot;, max + 1);&#10;    }&#10;&#10;    // Sinh số điện thoại ngẫu nhiên, đảm bảo không trùng với các khách hàng đã có&#10;    private String generateUniquePhoneNumber(List&lt;KhachHang&gt; allKH) {&#10;        java.util.Set&lt;String&gt; usedPhones = allKH.stream().map(KhachHang::getSoDienThoai).collect(Collectors.toSet());&#10;        String phone;&#10;        do {&#10;            phone = &quot;09&quot; + (long)(Math.random() * 1_000_000_000L);&#10;            phone = phone.substring(0, 10); // Đảm bảo 10 số&#10;        } while (usedPhones.contains(phone));&#10;        return phone;&#10;    }&#10;&#10;    // Chuyển chuỗi định dạng tiền tệ về số double&#10;    private double parseCurrency(String currencyString) throws Exception {&#10;        if (currencyString == null || currencyString.trim().isEmpty()) {&#10;            return 0;&#10;        }&#10;        // Loại bỏ ký tự không phải số và không phải dấu chấm thập phân&#10;        String numericString = currencyString.replaceAll(&quot;[^0-9]&quot;, &quot;&quot;);&#10;        return Double.parseDouble(numericString);&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="//&#10;// Source code recreated from a .class file by IntelliJ IDEA&#10;// (powered by FernFlower decompiler)&#10;//&#10;&#10;package com.antam.app.controller.hoadon;&#10;&#10;import com.antam.app.dao.*;&#10;import com.antam.app.entity.*;&#10;import javafx.collections.FXCollections;&#10;import javafx.fxml.FXML;&#10;import javafx.scene.control.*;&#10;import javafx.scene.control.ButtonBar.ButtonData;&#10;import javafx.scene.layout.HBox;&#10;import javafx.scene.layout.VBox;&#10;import javafx.scene.text.Text;&#10;&#10;import java.text.DecimalFormat;&#10;import java.text.DecimalFormatSymbols;&#10;import java.util.List;&#10;import java.util.HashMap;&#10;import java.util.Map;&#10;import java.util.stream.Collectors;&#10;&#10;public class ThemHoaDonFormController {&#10;    @FXML&#10;    private DialogPane dialogPane;&#10;    @FXML&#10;    private TextField txtMaHoaDon;&#10;    @FXML&#10;    private TextField txtSoDienThoai;&#10;    @FXML&#10;    private TextField txtTenKhachHang;&#10;    @FXML&#10;    private ComboBox&lt;Thuoc&gt; cbMedicine;&#10;    @FXML&#10;    private ComboBox&lt;DonViTinh&gt; cb_unit;&#10;    @FXML&#10;    private TextField txt_price;&#10;    @FXML&#10;    private TextField txtQuantity;&#10;    @FXML&#10;    private Text txtTamTinh;&#10;    @FXML&#10;    private Text txtThue;&#10;    @FXML&#10;    private Text txtTongTien;&#10;    @FXML&#10;    private VBox medicineRowsVBox;&#10;    @FXML&#10;    private Button btnThemThuoc;&#10;    @FXML&#10;    private ComboBox&lt;KhuyenMai&gt; cb_promotion;&#10;    @FXML&#10;    private Text txtThongTinKhuyenMai;&#10;    @FXML&#10;    private Text txtWarning;&#10;&#10;    // Định dạng tiền tệ kiểu Việt Nam: 1.000đ, 10.000đ&#10;    private static final DecimalFormat VND_FORMAT;&#10;    static {&#10;        DecimalFormatSymbols symbols = new DecimalFormatSymbols();&#10;        symbols.setGroupingSeparator('.');&#10;        symbols.setDecimalSeparator(',');&#10;        VND_FORMAT = new DecimalFormat(&quot;#,##0&quot;, symbols);&#10;    }&#10;&#10;    public ThemHoaDonFormController() {&#10;    }&#10;&#10;    public void initialize() {&#10;        ButtonType cancelButton = new ButtonType(&quot;Huỷ&quot;, ButtonData.CANCEL_CLOSE);&#10;        ButtonType applyButton = new ButtonType(&quot;Tạo hoá đơn&quot;, ButtonData.APPLY);&#10;        this.dialogPane.getButtonTypes().add(cancelButton);&#10;        this.dialogPane.getButtonTypes().add(applyButton);&#10;&#10;        // Tự động sinh mã hoá đơn mới&#10;        txtMaHoaDon.setText(generateNewMaHoaDon());&#10;        txtMaHoaDon.setEditable(false); // Khóa không cho sửa mã hoá đơn&#10;&#10;        // Xử lý tìm kiếm khách hàng realtime khi nhập số điện thoại&#10;        KhachHang_DAO khachHangDAO = new KhachHang_DAO();&#10;        txtSoDienThoai.textProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;            if (newVal != null &amp;&amp; !newVal.trim().isEmpty()) {&#10;                // Tìm khách hàng theo số điện thoại&#10;                KhachHang kh = khachHangDAO.getKhachHangTheoSoDienThoai(newVal.trim());&#10;                if (kh != null) {&#10;                    // Nếu tìm thấy khách hàng, tự động điền tên và disable ô tên&#10;                    txtTenKhachHang.setText(kh.getTenKH());&#10;                    txtTenKhachHang.setDisable(true);&#10;                    txtTenKhachHang.setStyle(&quot;-fx-opacity: 1.0;&quot;); // Giữ màu chữ rõ ràng khi disable&#10;                } else {&#10;                    // Nếu không tìm thấy, cho phép nhập tên mới&#10;                    txtTenKhachHang.clear();&#10;                    txtTenKhachHang.setDisable(false);&#10;                    txtTenKhachHang.setStyle(&quot;&quot;);&#10;                }&#10;            } else {&#10;                // Nếu xóa số điện thoại, reset ô tên&#10;                txtTenKhachHang.clear();&#10;                txtTenKhachHang.setDisable(false);&#10;                txtTenKhachHang.setStyle(&quot;&quot;);&#10;            }&#10;        });&#10;&#10;        // Load thuốc vào cbMedicine&#10;        Thuoc_DAO thuocDAO = new Thuoc_DAO();&#10;        var thuocList = FXCollections.observableArrayList(thuocDAO.getAllThuoc());&#10;        cbMedicine.setItems(thuocList);&#10;        cbMedicine.setConverter(new javafx.util.StringConverter&lt;&gt;() {&#10;            @Override&#10;            public String toString(Thuoc thuoc) {&#10;                return thuoc == null ? &quot;&quot; : thuoc.getTenThuoc();&#10;            }&#10;            @Override&#10;            public Thuoc fromString(String s) {&#10;                return thuocList.stream().filter(t -&gt; t.getTenThuoc().equals(s)).findFirst().orElse(null);&#10;            }&#10;        });&#10;&#10;//        cbMedicine.valueProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;//            if (newVal != null) {&#10;//                // Lấy danh sách đơn vị tính quy đổi cho thuốc&#10;//                QuyDoi_DAO quyDoiDAO = new QuyDoi_DAO();&#10;//                DonViTinh_DAO donViTinhDAO = new DonViTinh_DAO();&#10;//                var allQuyDoi = quyDoiDAO.getAllQuyDoi();&#10;//                var quyDoiList = allQuyDoi.getOrDefault(newVal.getMaThuoc(), List.of());&#10;//                HashSet&lt;Integer&gt; dvtIdSet = new HashSet&lt;&gt;();&#10;//                // Thêm đơn vị cơ sở&#10;//                dvtIdSet.add(newVal.getMaDVTCoSo().getMaDVT());&#10;//                // Thêm các đơn vị quy đổi&#10;//                for (QuyDoi qd : quyDoiList) {&#10;//                    dvtIdSet.add(qd.getMaDVTCha().getMaDVT());&#10;//                    dvtIdSet.add(qd.getMaDVTCon().getMaDVT());&#10;//                }&#10;//                HashSet&lt;DonViTinh&gt; dvtSet = new HashSet&lt;&gt;();&#10;//                for (Integer maDVT : dvtIdSet) {&#10;//                    DonViTinh dvt = donViTinhDAO.getDVTTheoMa(maDVT);&#10;//                    if (dvt != null) dvtSet.add(dvt);&#10;//                }&#10;//                cb_unit.setItems(FXCollections.observableArrayList(dvtSet));&#10;//                cb_unit.getSelectionModel().selectFirst();&#10;//                // Hiển thị giá bán&#10;//                txt_price.setText(VND_FORMAT.format(newVal.getGiaBan()) + &quot;đ&quot;);&#10;//                updateSummary();&#10;//            } else {&#10;//                cb_unit.getItems().clear();&#10;//                txt_price.clear();&#10;//                txtTamTinh.setText(&quot;&quot;);&#10;//                txtThue.setText(&quot;&quot;);&#10;//                txtTongTien.setText(&quot;&quot;);&#10;//            }&#10;//        });&#10;        txtQuantity.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        txt_price.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        cb_unit.valueProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        btnThemThuoc.setOnAction(e -&gt; addMedicineRow());&#10;        if (!medicineRowsVBox.getChildren().isEmpty() &amp;&amp; medicineRowsVBox.getChildren().get(0) instanceof HBox hbox) {&#10;            setupMedicineRow(hbox);&#10;        }&#10;&#10;        // Load khuyến mãi vào cb_promotion&#10;        KhuyenMai_DAO khuyenMaiDAO = new KhuyenMai_DAO();&#10;        var dsKhuyenMai = khuyenMaiDAO.getAllKhuyenMaiConHieuLuc();&#10;        cb_promotion.setItems(FXCollections.observableArrayList(dsKhuyenMai));&#10;        cb_promotion.setConverter(new javafx.util.StringConverter&lt;&gt;() {&#10;            @Override&#10;            public String toString(KhuyenMai km) {&#10;                return km == null ? &quot;&quot; : km.getTenKM();&#10;            }&#10;            @Override&#10;            public KhuyenMai fromString(String s) {&#10;                return dsKhuyenMai.stream().filter(km -&gt; km.getTenKM().equals(s)).findFirst().orElse(null);&#10;            }&#10;        });&#10;&#10;        // Hiển thị thông tin khuyến mãi khi chọn&#10;        cb_promotion.valueProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;            if (newVal != null) {&#10;                txtThongTinKhuyenMai.setText(&#10;                    String.format(&quot;%s (Từ %s đến %s)\nLoại: %s, Giá trị: %s%s&quot;,&#10;                        newVal.getTenKM(),&#10;                        newVal.getNgayBatDau(),&#10;                        newVal.getNgayKetThuc(),&#10;                        newVal.getLoaiKhuyenMai().getTenLKM(),&#10;                        newVal.getSo(),&#10;                        newVal.getLoaiKhuyenMai().getTenLKM().toLowerCase().contains(&quot;%&quot;) ? &quot;%&quot; : &quot;&quot;&#10;                    )&#10;                );&#10;            } else {&#10;                txtThongTinKhuyenMai.setText(&quot;&quot;);&#10;            }&#10;            updateSummary();&#10;        });&#10;&#10;        // Xử lý khi nhấn nút tạo hoá đơn&#10;        Button btnTaoHoaDon = (Button) dialogPane.lookupButton(applyButton);&#10;        // Validate dữ liệu trước khi tạo hoá đơn&#10;        btnTaoHoaDon.addEventFilter(javafx.event.ActionEvent.ACTION, e -&gt; {&#10;            // Reset warning&#10;            txtWarning.setVisible(false);&#10;            txtWarning.setText(&quot;&quot;);&#10;&#10;            // Validate số điện thoại&#10;            String soDienThoai = txtSoDienThoai.getText().trim();&#10;            if (soDienThoai.isEmpty()) {&#10;                txtWarning.setText(&quot;Vui lòng nhập số điện thoại khách hàng!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;&#10;            // Validate tên khách hàng&#10;            String tenKH = txtTenKhachHang.getText().trim();&#10;            if (tenKH.isEmpty()) {&#10;                txtWarning.setText(&quot;Vui lòng nhập tên khách hàng!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            boolean hasMedicine = false;&#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    ComboBox&lt;Thuoc&gt; cb = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                    if (cb.getValue() != null) {&#10;                        hasMedicine = true;&#10;                        break;&#10;                    }&#10;                }&#10;            }&#10;            if (!hasMedicine) {&#10;                txtWarning.setText(&quot;Vui lòng chọn ít nhất một thuốc!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            boolean hasQuantity = false;&#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                    if (!txtQuantity.getText().trim().isEmpty()) {&#10;                        hasQuantity = true;&#10;                        break;&#10;                    }&#10;                }&#10;            }&#10;            if (!hasQuantity) {&#10;                txtWarning.setText(&quot;Vui lòng nhập số lượng thuốc!&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            } else {&#10;                // Kiểm tra số lượng có hợp lệ không&#10;                for (var node : medicineRowsVBox.getChildren()) {&#10;                    if (node instanceof HBox hbox) {&#10;                        TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                        String qtyStr = txtQuantity.getText().trim();&#10;                        if (!qtyStr.isEmpty()) {&#10;                            try {&#10;                                int qty = Integer.parseInt(qtyStr);&#10;                                if (qty &lt;= 0) {&#10;                                    txtWarning.setText(&quot;Số lượng thuốc phải là số nguyên dương!&quot;);&#10;                                    txtWarning.setVisible(true);&#10;                                    e.consume();&#10;                                    return;&#10;                                }&#10;                            } catch (NumberFormatException ex) {&#10;                                txtWarning.setText(&quot;Số lượng thuốc phải là số nguyên hợp lệ!&quot;);&#10;                                txtWarning.setVisible(true);&#10;                                e.consume();&#10;                                return;&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;            // Kiểm tra tồn kho cho từng thuốc&#10;            ChiTietThuoc_DAO chiTietThuocDAO = new ChiTietThuoc_DAO();&#10;            &#10;            // Validate và gộp số lượng thuốc trùng lặp&#10;            Map&lt;String, Integer&gt; medicineQuantityMap = new HashMap&lt;&gt;();&#10;            Map&lt;String, Double&gt; medicinePriceMap = new HashMap&lt;&gt;();&#10;            Map&lt;String, DonViTinh&gt; medicineUnitMap = new HashMap&lt;&gt;();&#10;            &#10;            for (var node : medicineRowsVBox.getChildren()) {&#10;                if (node instanceof HBox hbox) {&#10;                    ComboBox&lt;Thuoc&gt; cb = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                    ComboBox&lt;DonViTinh&gt; cbUnit = (ComboBox&lt;DonViTinh&gt;) hbox.getChildren().get(1);&#10;                    TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                    TextField txtPrice = (TextField) hbox.getChildren().get(3);&#10;                    Thuoc thuoc = cb.getValue();&#10;                    DonViTinh dvt = cbUnit.getValue();&#10;                    int soLuong = 0;&#10;                    double donGia = 0;&#10;                    try { soLuong = Integer.parseInt(txtQuantity.getText().trim()); } catch(Exception ex) {}&#10;                    try { donGia = parseCurrency(txtPrice.getText().trim()); } catch(Exception ex) {}&#10;                    &#10;                    if (thuoc != null &amp;&amp; dvt != null &amp;&amp; soLuong &gt; 0) {&#10;                        String maThuoc = thuoc.getMaThuoc();&#10;                        // Gộp số lượng nếu thuốc trùng&#10;                        medicineQuantityMap.put(maThuoc, medicineQuantityMap.getOrDefault(maThuoc, 0) + soLuong);&#10;                        medicinePriceMap.put(maThuoc, donGia);&#10;                        medicineUnitMap.put(maThuoc, dvt);&#10;                    }&#10;                }&#10;            }&#10;            &#10;            // Kiểm tra tồn kho cho các thuốc đã gộp&#10;            boolean enoughStock = true;&#10;            String outOfStockMedicine = null;&#10;            for (Map.Entry&lt;String, Integer&gt; entry : medicineQuantityMap.entrySet()) {&#10;                String maThuoc = entry.getKey();&#10;                int tongSoLuong = entry.getValue();&#10;                int tongTonKho = chiTietThuocDAO.getTongTonKhoTheoMaThuoc(maThuoc);&#10;                if (tongTonKho &lt; tongSoLuong) {&#10;                    enoughStock = false;&#10;                    // Tìm tên thuốc để hiển thị&#10;                    for (var node : medicineRowsVBox.getChildren()) {&#10;                        if (node instanceof HBox hbox) {&#10;                            ComboBox&lt;Thuoc&gt; cb = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                            Thuoc thuoc = cb.getValue();&#10;                            if (thuoc != null &amp;&amp; thuoc.getMaThuoc().equals(maThuoc)) {&#10;                                outOfStockMedicine = thuoc.getTenThuoc();&#10;                                break;&#10;                            }&#10;                        }&#10;                    }&#10;                    break;&#10;                }&#10;            }&#10;            &#10;            if (!enoughStock) {&#10;                txtWarning.setText(&quot;Số lượng tồn không đủ cho thuốc: &quot; + outOfStockMedicine);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            // Tiến hành tạo hoá đơn&#10;            txtWarning.setVisible(false);&#10;            txtWarning.setText(&quot;&quot;);&#10;&#10;            // 1. Lấy mã khách hàng (tự động thêm nếu chưa có)&#10;            String maKH = getOrCreateMaKhachHang();&#10;            KhachHang kh = khachHangDAO.getKhachHangTheoMa(maKH);&#10;&#10;            // 2. Lấy nhân viên (nếu có ComboBox chọn nhân viên, ví dụ cbEmployee)&#10;            NhanVien_DAO nhanVienDAO = new NhanVien_DAO();&#10;            NhanVien nhanVien = PhienNguoiDung.getMaNV(); // Hardcode mã nhân viên&#10;            if (nhanVien == null || nhanVien.getMaNV() == null) {&#10;                txtWarning.setText(&quot;Không tìm thấy nhân viên hợp lệ! Không thể tạo hóa đơn.&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;&#10;            // 3. Lấy khuyến mãi (đã có đối tượng km)&#10;            KhuyenMai km = cb_promotion.getValue();&#10;            // 4. Lấy mã hoá đơn&#10;            String maHD = txtMaHoaDon.getText().trim();&#10;            // 5. Lấy tổng tiền, tạm tính, thuế, khuyến mãi&#10;            double tongTien = 0, tamTinh = 0, thue = 0, giam = 0;&#10;            try { tamTinh = parseCurrency(txtTamTinh.getText()); } catch(Exception ex) {}&#10;            try { thue = parseCurrency(txtThue.getText()); } catch(Exception ex) {}&#10;            try {&#10;                String tong = txtTongTien.getText().replaceAll(&quot;[^0-9]&quot;, &quot;&quot;);&#10;                tongTien = tong.isEmpty() ? 0 : Double.parseDouble(tong);&#10;            } catch(Exception ex) {}&#10;            // 6. Tạo hoá đơn đúng kiểu constructor&#10;            HoaDon_DAO hoaDonDAO = new HoaDon_DAO();&#10;            HoaDon hoaDon = new HoaDon(maHD, java.time.LocalDate.now(), nhanVien, kh, km, tongTien, false);&#10;            boolean hoaDonInserted = hoaDonDAO.insertHoaDon(hoaDon);&#10;            if (!hoaDonInserted) {&#10;                txtWarning.setText(&quot;Tạo hóa đơn thất bại! Vui lòng kiểm tra lại thông tin.&quot;);&#10;                txtWarning.setVisible(true);&#10;                e.consume();&#10;                return;&#10;            }&#10;            // 5. Thêm chi tiết hoá đơn cho từng thuốc và trừ kho (sử dụng map đã gộp)&#10;            ChiTietHoaDon_DAO chiTietHoaDonDAO = new ChiTietHoaDon_DAO();&#10;            Thuoc_DAO thuocDAO = new Thuoc_DAO();&#10;            &#10;            for (Map.Entry&lt;String, Integer&gt; entry : medicineQuantityMap.entrySet()) {&#10;                String maThuoc = entry.getKey();&#10;                int soLuong = entry.getValue();&#10;                double donGia = medicinePriceMap.get(maThuoc);&#10;                DonViTinh dvt = medicineUnitMap.get(maThuoc);&#10;                &#10;                Thuoc thuoc = thuocDAO.getThuocTheoMa(maThuoc);&#10;                if (thuoc != null &amp;&amp; dvt != null &amp;&amp; soLuong &gt; 0) {&#10;                    // Lấy danh sách các lô ChiTietThuoc còn tồn kho cho thuốc này&#10;                    List&lt;ChiTietThuoc&gt; listCTT = chiTietThuocDAO.getAllChiTietThuoc().stream()&#10;                        .filter(ctt -&gt; ctt.getMaThuoc().getMaThuoc().equals(maThuoc) &amp;&amp; ctt.getSoLuong() &gt; 0)&#10;                        .sorted(java.util.Comparator.comparing(ctt -&gt; ctt.getHanSuDung())) // Ưu tiên lô hết hạn trước&#10;                        .collect(Collectors.toList());&#10;                    int soLuongConLai = soLuong;&#10;                    for (ChiTietThuoc ctt : listCTT) {&#10;                        if (soLuongConLai &lt;= 0) break;&#10;                        int soLuongXuat = Math.min(ctt.getSoLuong(), soLuongConLai);&#10;                        if (soLuongXuat &lt;= 0) continue;&#10;                        ChiTietHoaDon cthd = new ChiTietHoaDon(new HoaDon(maHD), ctt, soLuongXuat, dvt, &quot;Bán&quot;, soLuongXuat * donGia);&#10;                        chiTietHoaDonDAO.themChiTietHoaDon(cthd);&#10;                        // Trừ kho lô này&#10;                        chiTietThuocDAO.CapNhatSoLuongChiTietThuoc(ctt.getMaCTT(), -soLuongXuat);&#10;                        soLuongConLai -= soLuongXuat;&#10;                    }&#10;                }&#10;            }&#10;            &#10;            // Đóng dialog (nếu cần, có thể show alert thành công ở đây)&#10;            dialogPane.getScene().getWindow().hide();&#10;            Alert successAlert = new Alert(Alert.AlertType.INFORMATION);&#10;            successAlert.setTitle(&quot;Tạo hoá đơn thành công&quot;);&#10;            successAlert.setHeaderText(null);&#10;            successAlert.setContentText(&quot;Hoá đơn đã được tạo thành công!&quot;);&#10;            successAlert.showAndWait();&#10;        });&#10;    }&#10;&#10;    // Thêm một hàng thuốc mới vào VBox chứa các hàng thuốc&#10;    private void addMedicineRow() {&#10;        HBox hbox = new HBox(10);&#10;        hbox.setStyle(&quot;-fx-background-color: #f8fafc;&quot;);&#10;        hbox.setPadding(new javafx.geometry.Insets(10));&#10;        ComboBox&lt;Thuoc&gt; cbMedicine = new ComboBox&lt;&gt;();&#10;        cbMedicine.setPrefWidth(150);&#10;        cbMedicine.setPromptText(&quot;Chọn thuốc&quot;);&#10;        cbMedicine.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        ComboBox&lt;DonViTinh&gt; cb_unit = new ComboBox&lt;&gt;();&#10;        cb_unit.setPrefWidth(150);&#10;        cb_unit.setPromptText(&quot;Đơn vị&quot;);&#10;        cb_unit.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        TextField txtQuantity = new TextField();&#10;        txtQuantity.setPromptText(&quot;Số lượng&quot;);&#10;        txtQuantity.getStyleClass().add(&quot;text-field&quot;);&#10;        txtQuantity.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        TextField txt_price = new TextField();&#10;        txt_price.setPromptText(&quot;Đơn giá&quot;);&#10;        txt_price.getStyleClass().add(&quot;text-field&quot;);&#10;        txt_price.getStylesheets().add(getClass().getResource(&quot;/com/antam/app/styles/dashboard_style.css&quot;).toExternalForm());&#10;        Button btnRemove = new Button(&quot;X&quot;);&#10;        btnRemove.setStyle(&#10;            &quot;-fx-padding: 5 8 5 8;&quot; +&#10;            &quot;-fx-background-color: #ef4444;&quot; +&#10;            &quot;-fx-background-radius: 50%;&quot; +&#10;            &quot;-fx-text-fill: white;&quot; +&#10;            &quot;-fx-font-size: 14px;&quot; +&#10;            &quot;-fx-font-weight: bold;&quot;&#10;        );&#10;        btnRemove.setOnAction(e -&gt; medicineRowsVBox.getChildren().remove(hbox));&#10;        hbox.getChildren().addAll(cbMedicine, cb_unit, txtQuantity, txt_price, btnRemove);&#10;        medicineRowsVBox.getChildren().add(hbox);&#10;        setupMedicineRow(hbox);&#10;    }&#10;&#10;    // Thiết lập sự kiện và logic cho một hàng thuốc mới thêm vào&#10;    private void setupMedicineRow(HBox hbox) {&#10;        ComboBox&lt;Thuoc&gt; cbMedicine = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;        ComboBox&lt;DonViTinh&gt; cb_unit = (ComboBox&lt;DonViTinh&gt;) hbox.getChildren().get(1);&#10;        TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;        TextField txt_price = (TextField) hbox.getChildren().get(3);&#10;        txt_price.setEditable(false); // Khóa không cho sửa giá&#10;        Thuoc_DAO thuocDAO = new Thuoc_DAO();&#10;        var thuocList = FXCollections.observableArrayList(thuocDAO.getAllThuoc());&#10;        cbMedicine.setItems(thuocList);&#10;        cbMedicine.setConverter(new javafx.util.StringConverter&lt;&gt;() {&#10;            @Override&#10;            public String toString(Thuoc thuoc) {&#10;                return thuoc == null ? &quot;&quot; : thuoc.getTenThuoc();&#10;            }&#10;            @Override&#10;            public Thuoc fromString(String s) {&#10;                return thuocList.stream().filter(t -&gt; t.getTenThuoc().equals(s)).findFirst().orElse(null);&#10;            }&#10;        });&#10;&#10;        // Khi chọn thuốc, tự động set đơn vị cơ sở và không cho chọn đơn vị khác&#10;        cbMedicine.valueProperty().addListener((obs, oldVal, newVal) -&gt; {&#10;            if (newVal != null) {&#10;                DonViTinh_DAO donViTinhDAO = new DonViTinh_DAO();&#10;                // Chỉ lấy đơn vị cơ sở của thuốc&#10;                DonViTinh dvtCoSo = newVal.getMaDVTCoSo();&#10;                if (dvtCoSo != null) {&#10;                    // Lấy thông tin đầy đủ của đơn vị tính từ database&#10;                    DonViTinh dvtFull = donViTinhDAO.getDVTTheoMa(dvtCoSo.getMaDVT());&#10;                    if (dvtFull != null) {&#10;                        cb_unit.setItems(FXCollections.observableArrayList(dvtFull));&#10;                        cb_unit.getSelectionModel().selectFirst();&#10;                        cb_unit.setDisable(true); // Không cho chọn đơn vị khác&#10;                    }&#10;                }&#10;                // Hiển thị giá bán&#10;                txt_price.setText(VND_FORMAT.format(newVal.getGiaBan()) + &quot;đ&quot;);&#10;            } else {&#10;                cb_unit.getItems().clear();&#10;                cb_unit.setDisable(false);&#10;                txt_price.clear();&#10;            }&#10;            updateSummary();&#10;        });&#10;&#10;        txtQuantity.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        txt_price.textProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;        cb_unit.valueProperty().addListener((obs, oldVal, newVal) -&gt; updateSummary());&#10;    }&#10;&#10;    //Hàm tính tổng tiền, tạm tính Cập nhật lại phần tóm tắt hoá đơn (tạm tính, thuế, tổng tiền)&#10;    private void updateSummary() {&#10;        double tongTamTinh = 0;&#10;        double tongThue = 0;&#10;        double tongTien = 0;&#10;        for (var node : medicineRowsVBox.getChildren()) {&#10;            if (node instanceof HBox hbox) {&#10;                ComboBox&lt;Thuoc&gt; cbMedicine = (ComboBox&lt;Thuoc&gt;) hbox.getChildren().get(0);&#10;                TextField txtQuantity = (TextField) hbox.getChildren().get(2);&#10;                TextField txt_price = (TextField) hbox.getChildren().get(3);&#10;                txt_price.setEditable(false); // Khóa không cho sửa giá&#10;                int quantity = 0;&#10;                try {&#10;                    quantity = Integer.parseInt(txtQuantity.getText().trim());&#10;                } catch (Exception ignored) {}&#10;                double price = 0;&#10;                try {&#10;                    price = parseCurrency(txt_price.getText().trim());&#10;                } catch (Exception ignored) {}&#10;                double taxPercent = 0;&#10;                Thuoc selectedThuoc = cbMedicine.getValue();&#10;                if (selectedThuoc != null) {&#10;                    taxPercent = selectedThuoc.getThue();&#10;                }&#10;                double tamTinh = quantity * price;&#10;                // Tính thuế VAT: giá chưa bao gồm thuế, thuế = thành tiền × tỷ lệ thuế&#10;                double thue = tamTinh * taxPercent;&#10;                tongTamTinh += tamTinh;&#10;                tongThue += thue;&#10;            }&#10;        }&#10;        tongTien = tongTamTinh + tongThue;&#10;        // Áp dụng khuyến mãi nếu có&#10;        KhuyenMai km = cb_promotion.getValue();&#10;        double giam = 0;&#10;        if (km != null) {&#10;            double so = km.getSo();&#10;            if (so &lt; 100) {&#10;                giam = tongTien * so / 100.0;&#10;            } else if (so &gt;= 1000) {&#10;                giam = so;&#10;            }&#10;            if (giam &gt; tongTien) giam = tongTien;&#10;            tongTien -= giam;&#10;        }&#10;        txtTamTinh.setText(VND_FORMAT.format(tongTamTinh) + &quot;đ&quot;);&#10;        txtThue.setText(VND_FORMAT.format(tongThue) + &quot;đ&quot;);&#10;        if (km != null &amp;&amp; giam &gt; 0) {&#10;            txtTongTien.setText(VND_FORMAT.format(tongTien) + &quot;đ (đã giảm &quot; + VND_FORMAT.format(giam) + &quot;đ)&quot;);&#10;        } else {&#10;            txtTongTien.setText(VND_FORMAT.format(tongTien) + &quot;đ&quot;);&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Sinh mã hoá đơn mới chưa tồn tại trong CSDL dạng HDxxx&#10;     */&#10;    private String generateNewMaHoaDon() {&#10;        HoaDon_DAO hoaDonDAO = new HoaDon_DAO();&#10;        List&lt;String&gt; allMaHD = hoaDonDAO.getAllHoaDon().stream().map(hd -&gt; hd.getMaHD()).collect(Collectors.toList());&#10;        int max = 0;&#10;        for (String ma : allMaHD) {&#10;            if (ma != null &amp;&amp; ma.matches(&quot;HD\\d+&quot;)) {&#10;                int num = Integer.parseInt(ma.substring(2));&#10;                if (num &gt; max) max = num;&#10;            }&#10;        }&#10;        return String.format(&quot;HD%03d&quot;, max + 1);&#10;    }&#10;&#10;    // Xử lý khi nhấn nút tạo hóa đơn - Lấy hoặc tạo mã khách hàng dựa trên số điện thoại&#10;    private String getOrCreateMaKhachHang() {&#10;        String soDienThoai = txtSoDienThoai.getText().trim();&#10;        String tenKH = txtTenKhachHang.getText().trim();&#10;        if (soDienThoai.isEmpty() || tenKH.isEmpty()) return null;&#10;&#10;        KhachHang_DAO khachHangDAO = new KhachHang_DAO();&#10;&#10;        // Tìm khách hàng theo số điện thoại&#10;        KhachHang existingKH = khachHangDAO.getKhachHangTheoSoDienThoai(soDienThoai);&#10;        if (existingKH != null) {&#10;            // Nếu đã có khách hàng với số điện thoại này, trả về mã của họ&#10;            return existingKH.getMaKH();&#10;        }&#10;&#10;        // Nếu chưa có, tạo khách hàng mới với số điện thoại và tên đã nhập&#10;        List&lt;KhachHang&gt; allKH = khachHangDAO.getAllKhachHang();&#10;        String newMaKH = generateNewMaKhachHang(allKH);&#10;        KhachHang newKH = new KhachHang(newMaKH, tenKH, soDienThoai, false);&#10;        khachHangDAO.insertKhachHang(newKH);&#10;        return newMaKH;&#10;    }&#10;&#10;    // Sinh mã khách hàng mới chưa tồn tại trong CSDL dạng KHxxx hoặc KH000000001&#10;    private String generateNewMaKhachHang(List&lt;KhachHang&gt; allKH) {&#10;        int max = 0;&#10;        int digitCount = 3; // Mặc định nếu chưa có mã nào&#10;        for (KhachHang kh : allKH) {&#10;            String ma = kh.getMaKH();&#10;            if (ma != null &amp;&amp; ma.matches(&quot;KH\\d+&quot;)) {&#10;                String numberPart = ma.substring(2);&#10;                int num = Integer.parseInt(numberPart);&#10;                if (num &gt; max) max = num;&#10;                if (numberPart.length() &gt; digitCount) digitCount = numberPart.length();&#10;            }&#10;        }&#10;        return String.format(&quot;KH%0&quot; + digitCount + &quot;d&quot;, max + 1);&#10;    }&#10;&#10;    // Sinh số điện thoại ngẫu nhiên, đảm bảo không trùng với các khách hàng đã có&#10;    private String generateUniquePhoneNumber(List&lt;KhachHang&gt; allKH) {&#10;        java.util.Set&lt;String&gt; usedPhones = allKH.stream().map(KhachHang::getSoDienThoai).collect(Collectors.toSet());&#10;        String phone;&#10;        do {&#10;            phone = &quot;09&quot; + (long)(Math.random() * 1_000_000_000L);&#10;            phone = phone.substring(0, 10); // Đảm bảo 10 số&#10;        } while (usedPhones.contains(phone));&#10;        return phone;&#10;    }&#10;&#10;    // Chuyển chuỗi định dạng tiền tệ về số double&#10;    private double parseCurrency(String currencyString) throws Exception {&#10;        if (currencyString == null || currencyString.trim().isEmpty()) {&#10;            return 0;&#10;        }&#10;        // Loại bỏ ký tự không phải số và không phải dấu chấm thập phân&#10;        String numericString = currencyString.replaceAll(&quot;[^0-9]&quot;, &quot;&quot;);&#10;        return Double.parseDouble(numericString);&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>